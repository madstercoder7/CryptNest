{% extends "layout.html" %}
{% block content %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: black;
        color: #f1f1f1;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .fullscreen-center {
        min-height: 100vh;
        padding-top: 70px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: black;
        overflow: hidden;
        padding-bottom: 300px;
    }
    
    .glass-card .btn-success { 
        background-color: #00a67e; 
        border: none; 
    }

    .glass-card .btn-success:hover { 
        background-color: #00916d; 
    }

    .glass-card .btn-outline-light { 
        border-color: #aaa; 
        color: #ddd; 
    }

    .glass-card .btn-outline-light:hover { 
        background-color: #111; 
        color: #fff; 
    }

    #video {
        width: 100%;
        border-radius: 12px;
        display: none;
        margin-bottom: 0.75rem;
    }
</style>

<div class="fullscreen-center">
    <div class="glass-card">
        <h3>Login to <span style="color: #00ffe7;">CryptNest</span></h3>
        <button type="button" class="btn btn-secondary" id="faceLoginBtn">Login with Face</button>
        <video id="loginVideo" width="300" height="225" autoplay muted></video>

        <form method="post">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.username.label(class="form-label") }}
                {{ form.username(class="form-control", placeholder="Enter your username", autocomplete="off") }}
            </div>
            <div class="mb-3">
                {{ form.password.label(class="form-label") }}
                <div class="input-group">
                    {{ form.password(class="form-control", placeholder="Enter your password", id="password") }}
                    <button class="btn btn-outline-light" onclick="togglePassword()" type="button">üëÅ</button>
                </div>
            </div>
            {{ form.submit(class="btn btn-success w-100") }}
        </form>

        <div class="mt-3 text-center">
            <small>Dont have an account? <a href="{{ url_for('register') }}">Register here</a></small>
        </div>
    </div>
</div>

<script>
    Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('/static/models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('/static/models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('/static/models')
    ]).then(() => console.log("Models loaded"))


    const usernameInput = document.querySelector('input[name="username"]');
    const faceBtn = document.getElementById("faceLoginBtn");
    faceBtn.disabled = true;
    const videoEl = document.getElementById("loginVideo");

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoEl.srcObject = stream;
            videoEl.style.display = "block";
            return stream; 
        } catch (e) {
            showToast("Camera access denied/unavailable", "danger");
            throw e;
        }
    }

    function stopStream(stream) {
        if (!stream) return;
        stream.getTracks().forEach(t => t.stop());
        videoEl.style.display = "none";
    }

    function captureFrame() {
        const canvas = document.createElement("canvas");
        canvas.width = videoEl.videoWidth || 320;
        canvas.height = videoEl.videoHeight || 240;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL("image/jpeg");
    }

    async function captureFaceDescriptor(videoEl) {
        const detection = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if (!detection) {
            showToast("No face detected, try again", "warning");
            return null;
        }
        return detection.descriptor;
    }

    faceBtn.addEventListener("click", async () => {
        const username = (usernameInput.value || '').trim();
        if (!username) return showToast("Please enter your username first", "warning");

        let stream;
        try {
            stream = await startCamera();
            setTimeout(async () => {
                const descriptor = await captureFaceDescriptor(videoEl);
                if (descriptor) {
                    try {
                        const res = await fetch("/verify_face_descriptor", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ username, descriptor: Array.from(descriptor) })
                        });
                        const out = await res.json();
                        if (out.success) {
                            showToast("Face recognized", "success");
                            window.location.href = out.redirect || "/dashboard";
                        } else {
                            showToast(out.message || "Face not recognized", "danger");
                        }
                    } catch (e) {
                        showToast("Face verification failed", "danger");
                    }
                }
                stopStream(stream);
            }, 800);
        } catch (e) {
            showToast(e.message, "danger");
        }
    });

    usernameInput.addEventListener("input", () => {
        faceBtn.disabled = !usernameInput.value.trim();
    });

    function togglePassword() {
        const input = document.getElementById("password");
        input.type = input.type === "password" ? "text" : "password";
    }
</script>
{% endblock %}