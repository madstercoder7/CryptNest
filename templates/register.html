{% extends "layout.html" %}
{% block content %}
<style>
html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0; 
    overflow: hidden; 
    background-color: black; 
    color: #f1f1f1; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
} 

.fullscreen-center { 
    min-height: 100vh; 
    padding-top: 70px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    background-color: black; 
    overflow: hidden; 
    padding-bottom: 300px; 
}

.glass-card .btn-success { 
    background-color: #00a67e; 
    border: none; 
}

.glass-card .btn-success:hover { 
    background-color: #00916d; 
}

.glass-card .btn-outline-light, .glass-card .btn-outline-warning { 
    border-color: #aaa; 
    color: #ddd; 
} 

.glass-card .btn-outline-light:hover, .glass-card .btn-outline-warning:hover { 
    background-color: #111; 
    color: #fff; 
}

#reg-video { 
    width: 100%; 
    border-radius: 12px; 
    display: none; 
    margin-bottom: 0.75rem; 
}
</style>

<div class="fullscreen-center">
    <div class="glass-card">
        <h3>Register on <span style="color:#00ffe7;">CryptNest</span></h3>

        <video id="reg-video" autoplay playsinline></video>

        <div class="text-center mb-3 d-grid gap-2">
            <button class="btn btn-outline-light btn-sm w-100" type="button" id="capture-face-btn">
                {% if session.get("face_captured") %} Recapture Face {% else %} Capture Face (Optional) {% endif %}
            </button>
        </div>

        <form method="post" id="register-form">
            {{ form.csrf_token }}
            <div class="mb-3">
                {{ form.username.label(class="form-label") }}
                {{ form.username(class="form-control", placeholder="Enter your username", autocomplete="off") }}
            </div>
            <div class="mb-3">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control", placeholder="Enter your email", autocomplete="off") }}
            </div>
            <div class="mb-3">
                {{ form.password.label(class="form-label") }}
                <div class="input-group">
                    {{ form.password(class="form-control", placeholder="Enter your password", id="password") }}
                    <button class="btn btn-outline-light" type="button" onclick="togglePassword('password')">üëÅ</button>
                </div>
                <small class="text-muted" id="strength-text"></small>
            </div>
            <div class="mb-3">
                {{ form.confirm_password.label(class="form-label") }}
                <div class="input-group">
                    {{ form.confirm_password(class="form-control", placeholder="Confirm your password", id="confirm_password") }}
                    <button class="btn btn-outline-light" type="button" onclick="togglePassword('confirm_password')">üëÅ</button>
                </div>
            </div>
            {{ form.submit(class="btn btn-success w-100") }}
        </form>

        <div class="mt-3 text-center">
            <small>Already have an account? <a href="{{ url_for('login') }}">Login</a> here</small>
        </div>
    </div>
</div>

<script>
const video = document.getElementById("reg-video");
const faceCaptureBtn = document.getElementById("capture-face-btn");

async function startCam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await video.play();
        video.style.display = "block";
        return stream;
    } catch {
        throw new Error("Camera access denied/unavailable");
    }
}

function stopCam(stream) {
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.style.display = "none";
}

function snap() {
    const c = document.createElement("canvas");
    c.width = video.videoWidth || 320;
    c.height = video.videoHeight || 240;
    c.getContext("2d").drawImage(video, 0, 0, c.width, c.height);
    return c.toDataURL("image/jpeg");
}

faceCaptureBtn.addEventListener("click", async () => {
    let stream;
    try {
        stream = await startCam();
        // wait a short time to ensure camera ready
        setTimeout(async () => {
            const dataUrl = snap();
            try {
                const res = await fetch("/face_capture_temp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image: dataUrl })
                });
                const out = await res.json();
                if (out.success) {
                    showToast("Face captured successfully", "success");
                    faceCaptureBtn.textContent = "Recapture Face";
                } else {
                    showToast(out.message || "Could not detect a face, try again", "danger");
                }
            } catch {
                showToast("Capture failed", "danger");
            } finally {
                stopCam(stream);
            }
        }, 500);
    } catch (e) {
        showToast(e.message, "danger");
    }
});

document.getElementById("password").addEventListener("input", function() {
    const val = this.value;
    let strength = "Weak";
    if (val.length > 8 && /[A-Z]/.test(val) && /\d/.test(val) && /[^A-Za-z0-9]/.test(val)) strength = "Strong";
    else if (val.length > 6) strength = "Medium";
    document.getElementById("strength-text").innerText = strength;
});

function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
}
</script>
{% endblock %}
