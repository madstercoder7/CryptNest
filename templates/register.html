{% extends "layout.html" %}
{% block content %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: black;
        color: #f1f1f1;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .fullscreen-center {
        min-height: 100vh;
        padding-top: 70px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: black;
        overflow: hidden;
        padding-bottom: 300px;
    }

    .glass-card .btn-success { background-color: #00a67e; border: none; }
    .glass-card .btn-success:hover { background-color: #00916d; }
    .glass-card .btn-outline-light, .glass-card .btn-outline-warning { border-color: #aaa; color: #ddd; }
    .glass-card .btn-outline-light:hover, .glass-card .btn-outline-warning:hover { background-color: #111; color: #fff; }
    #reg-video { width: 100%; border-radius: 12px; display: none; margin-bottom: 0.75rem; }
</style>

<div class="fullscreen-center">
    <div class="glass-card">
        <h3>üìù Register on <span style="color: #00ffe7;">CryptNest</span></h3>

        {% if session.get('face_captured') %}
            <div class="alert alert-success text-center p-2 py-1">‚úÖ Face captured successfully</div>
        {% endif %}

        <video id="reg-video" autoplay playsinline></video>

        <div class="text-center mb-3 d-grid gap-2">
            <button class="btn btn-outline-light btn-sm w-100" type="button" id="capture-face-btn">
                {% if session.get("face_captured") %} Recapture Face {% else %} Capture Face (Optional) {% endif %}
            </button>
        </div>

        <form method="post">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.username.label(class="form-label") }}
                {{ form.username(class="form-control", placeholder="Enter your username", autocomplete="off") }}
            </div>
            <div class="mb-3">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control", placeholder="Enter your email", autocomplete="off") }}
            </div>
            <div class="mb-3">
                {{ form.password.label(class="form-label") }}
                {{ form.password(class="form-control", placeholder="Enter your password") }}
            </div>
            <div class="mb-3">
                {{ form.confirm_password.label(class="form-label") }}
                {{ form.confirm_password(class="form-control", placeholder="Confirm your password") }}
            </div>
            {{ form.submit(class="btn btn-success w-100") }}
        </form>

        <div class="mt-3 text-center">
            <small>Already have an account? <a href="{{ url_for('login') }}">Login here</a></small>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById("reg-video");
    const btn = document.getElementById("capture-face-btn");

    async function startCam() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = "block";
        return stream;
    }

    function stopCam(stream) {
        if (stream) stream.getTracks().forEach(t => t.stop()); 
        video.style.display = "none";
    }

    function snap() {
        const c = document.createElement("canvas");
        c.width = video.videoWidth || 320;
        c.height = video.videoHeight || 240;
        c.getContext("2d").drawImage(video, 0, 0, c.width, c.height);
        return c.toDataURL("image/jpeg");
    }

    btn.addEventListener("click", async () => {
        let stream;
        try {
            stream = await startCam();
            setTimeout(async () => {
                const dataUrl = snap();
                try {
                    const res = await fetch("/face_capture_temp", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ image: dataUrl })
                    });
                    const out = await res.json();
                    if (out.success) {
                        location.reload();
                    } else {
                        alert(out.message || "Could not detect a face, try again");
                    }
                } catch (e) {
                    alert("Capture failed");
                } finally {
                    stopCam(stream);
                }
            }, 800); 
        } catch (e) {
            alert("Camera access denied/unavailable");
        }
    });
</script>
{% endblock %}
